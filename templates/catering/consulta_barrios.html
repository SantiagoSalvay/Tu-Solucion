{% extends 'base.html' %}

{% block title %}Consulta de Barrios - Marketing{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'catering:dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item active" aria-current="page">Consulta de Barrios</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Información de la Consulta -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-geo-alt me-2"></i>
                    Barrios Más Solicitados - Buenos Aires
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-0">
                    Esta consulta muestra los 10 barrios con mayor cantidad de servicios en Buenos Aires, 
                    considerando únicamente eventos finalizados.
                </p>
            </div>
        </div>

        <!-- Resultados -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-list-ol me-2"></i>
                    Top 10 Barrios
                </h5>
            </div>
            <div class="card-body">
                {% if barrios %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Barrio</th>
                                    <th>Cantidad de Servicios</th>
                                    <th>Servicio de Mayor Costo</th>
                                    <th>Costo Máximo</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for barrio, datos in barrios %}
                                <tr>
                                    <td>
                                        <span class="badge bg-primary">{{ forloop.counter }}</span>
                                    </td>
                                    <td>
                                        <strong>{{ barrio }}</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ datos.cantidad_servicios }}</span>
                                    </td>
                                    <td>
                                        {% if datos.servicio_mayor_costo %}
                                            <a href="{% url 'catering:evento_detail' datos.servicio_mayor_costo.id_evento %}" class="text-decoration-none">
                                                Evento {{ datos.servicio_mayor_costo.id_evento }} - {{ datos.servicio_mayor_costo.get_tipo_evento_display }}
                                            </a>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>${{ datos.costo_maximo|floatformat:0 }}</strong>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Gráfico de Resumen -->
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Resumen</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>Total de barrios analizados:</strong> {{ barrios|length }}</p>
                                    <p><strong>Total de servicios:</strong> 
                                        {% with total_servicios=0 %}
                                            {% for barrio, datos in barrios %}
                                                {% with total_servicios=total_servicios|add:datos.cantidad_servicios %}{% endwith %}
                                            {% endfor %}
                                            {{ total_servicios }}
                                        {% endwith %}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Barrio con más servicios</h6>
                                </div>
                                <div class="card-body">
                                    {% if barrios %}
                                        {% with primer_barrio=barrios.0 %}
                                            <p><strong>{{ primer_barrio.0 }}</strong></p>
                                            <p class="text-muted">{{ primer_barrio.1.cantidad_servicios }} servicios</p>
                                        {% endwith %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-geo-alt" style="font-size: 3rem;"></i>
                        <p class="mt-3">No se encontraron datos de barrios</p>
                        <p class="text-muted">Asegúrate de tener eventos finalizados con ubicaciones en Buenos Aires</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
